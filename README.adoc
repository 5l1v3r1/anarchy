= Anarchy Operator

The Anarchy operator provides a method of managing state for otherwise stateless API operations.
The name "anarchy" is both ironic and to the point.
While the anarchy operator governs interactions with RESTful APIs, it leaves the nature of the requests open for configuration.

Anarchy is configured through the definition of governors.
Anarchy governors define the strategy for controlling an anarchy subject by defining actions to execute on the subject.
Actions are tracked as custom resources, allowing for complete visibility of current state of the subject.

== Architecture

image::docs/AnarchyDiagram.png[Anarchy Diagram]

== Installation

. Clone this repo to your local workstation:
+
----
$ git clone https://github.com/redhat-gpte-devopsautomation/anarchy-operator.git
----

. Change to the project directory and create a Build Config using the provided template:
+
----
$ oc process -f build-template.yaml | oc apply -f -
----

. Check your work:
+
----
$ oc get all
----

. Start the operator build:
+
----
$ oc start-build anarchy-operator --from-dir=.
----

. Start the ansible-runner build:
----
$ oc start-build anarchy-ansible-runner --from-dir=.
----

. Watch the build process:
+
----
$ oc logs -f anarchy-operator-1-build
----

. For the "deploy" step you'll have to provide the `APP_DOMAIN` parameter.
Find out your app domain from the output of this command:
+
----
$ oc whoami --show-console
https://console-openshift-console.apps.cluster-396f.sandbox663.opentlc.com
----

. Use the part starting with `apps.` as the `APP_DOMAIN` parameter and deploy the operator:
+
----
$ oc process -f deploy-template.yaml -p APP_DOMAIN=apps.cluster-396f.sandbox663.opentlc.com | oc apply -f -
Warning: oc apply should be used on resource created by either oc create --save-config or oc apply
namespace/anarchy-operator configured
serviceaccount/anarchy-operator created
rolebinding.rbac.authorization.k8s.io/anarchy-operator-edit created
service/anarchy-operator created
route.route.openshift.io/anarchy-operator created
deployment.extensions/anarchy-operator created
clusterrole.authorization.openshift.io/anarchy-operator created
clusterrolebinding.authorization.openshift.io/anarchy-operator:anarchy-operator:anarchy-operator created
customresourcedefinition.apiextensions.k8s.io/anarchyapis.anarchy.gpte.redhat.com created
customresourcedefinition.apiextensions.k8s.io/anarchygovernors.anarchy.gpte.redhat.com created
customresourcedefinition.apiextensions.k8s.io/anarchysubjects.anarchy.gpte.redhat.com created
customresourcedefinition.apiextensions.k8s.io/anarchyactions.anarchy.gpte.redhat.com created
----

. Check your work: make sure these 4 CRDs have been created:
+
----
$ oc get crd | grep anarchy.gpte.redhat.com
anarchyactions.anarchy.gpte.redhat.com                              2019-07-03T17:11:22Z
anarchyapis.anarchy.gpte.redhat.com                                 2019-07-03T17:11:22Z
anarchygovernors.anarchy.gpte.redhat.com                            2019-07-03T17:11:22Z
anarchysubjects.anarchy.gpte.redhat.com                             2019-07-03T17:11:22Z
----

. Check your work: make sure the operator's pod is running:
+
----
$ oc get pods
NAME                                READY   STATUS      RESTARTS   AGE
anarchy-operator-1-build            0/1     Completed   0          22m
anarchy-operator-5f7d7898d7-f6dww   1/1     Running     0          19m
----

== Anarchy Design

The Anarchy Operator is configured with custom resource types AnarchyAPI and AnarchyGovernor in order to manage AnarchySubject resources.
AnarchyAPI resources define how to communicate with an API endpoint while AnarchyGovernor resources define how to interact with APIs to create and manage AnarchySubject resources.
Each AnarchySubject is managed according to a single AnarchyGovernor.
The AnarchyGovernor defines actions to perform against APIs to instantiate and manage the AnarchySubject.
Each action performed for an AnarchySubject according to the AnarchyGovernor definition is represented as an AnarchyAction custom resource.
An AnarchyAction always begins with an call to an API.
The Anarchy operator listens for callbacks to its own API for events relating to actions such as notifications that an action has completed, or encountered an error.
The AnarchyGovernor defines event handlers for actions which may include scheduling further AnarchyActions to occur for the AnarchySubject.

This repository includes a test suite that demonstrates these capabilities by calling a test API.
The usage of the test suite is explained in the "Testing" section below.
The conceptual overview of the test design is described here.

Let's start with the AnarchySubject definition:

----
apiVersion: anarchy.gpte.redhat.com/v1
kind: AnarchySubject
metadata:
  generateName: test-
  namespace: anarchy-operator
spec:
  desiredState: started <1>
  governor: test <2>
  parameters: <3>
    openshift_release: "4.1"
    aws_region: us-east-1
    repo_version: "3.11"
    subdomain_base_suffix: .example.opentlc.com
----

<1> The desired state of the resource, this is an arbitrary string which should be implemented by the AnarchyGovernor.
<2> The test AnarchySubject references the name of the AnarchyGovernor that will manage it.
<3> Each subject may include a list of parameters to pass to the API, though the governor and API get the final say in how and when the parameters are used.

The test AnarchyGovernor definition is shown here:

----
apiVersion: anarchy.gpte.redhat.com/v1
kind: AnarchyGovernor
metadata:
  name: test
spec:
  # The name of the default AnarchyAPI which is used to handle api requests
  # for actions. This may be overridden for specific actions with
  # spec.actions[].request
  api: test

  # Parameters to pass to API calls for this governor. These override
  # parameters set on the AnarchyAPI and are overridden by parameters set on
  # the AnarchySubject
  parameters:
    cloud_provider: ec2
    aws_access_key_id:
      # Parameter values can refer to secrets with a `secretName` and
      # `secretKey`. Secrets used as parameter values must be in the
      # anarchy-operator namespace.
      secretName: test-aws-creds
      secretKey: aws_access_key_id
    aws_secret_access_key:
      secretName: test-aws-creds
      secretKey: aws_secret_access_key

  # The `subjectEventHandlers` provide configuration for how to respond to
  # AnarchySubjects being added, updated, and deleted.
  subjectEventHandlers:
  # The `add` event is processed only for subjects that are newly created. 
  - event: add
    # Ansible tasks to run in response to this event...
    tasks:
    # The `anarchy_subject_update` module is provided to make it easy to update
    # the AnarchySubject relating to the current action.
    - name: Set state provision-scheduled in subject status
      anarchy_subject_update:
        metadata:
          labels:
            state: provision-scheduled
        status:
          state: provision-scheduled
    # The `anarchy_schedule_action` module is used to create AnarchyActions
    # for the current AnarchySubject. In this case it schedules an
    # AnarchyAction to be processed immediately.
    - name: Start Provision
      anarchy_schedule_action:
        action: provision

  # The `update` event is processed when a resource changes and also when the
  # anarchy operator is restarted.
  - event: update
    tasks:
    # The `anarchy_subject` variable stores the state of the AnarchySubject
    # which triggered this update. A useful pattern is to implement state
    # handling using `spec.desiredState` and `status.state`.
    - when: >-
        anarchy_subject.spec.desiredState|default('') == 'started' and
        (anarchy_subject.status|default({})).state|default('') == 'stopped'
      block:
      - name: Set state start-scheduled in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: start-scheduled
          status:
            state: start-scheduled
      - name: Schedule start
        anarchy_schedule_action:
          action: start
    - when: >-
        anarchy_subject.spec.desiredState|default('stopped') == 'stopped' and
        (anarchy_subject.status|default({})).state|default('') == 'started'
      block:
      - name: Set state stop-scheduled in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: stop-scheduled
          status:
            state: stop-scheduled
      - name: Schedule stop
        anarchy_schedule_action:
          action: stop

  # The `delete` event is processed when a subject delete is requsted. This
  # is detected by the presence of a `metadata.deletionTimestamp`. This should
  # schedule an action that will result in removing the finalizer from the
  # subject when complete.
  - event: delete
    tasks:
    - name: Schedule destroy
      anarchy_schedule_action:
        action: destroy

  # Actions represent entry points for doing something related to a resource.
  # Each action consists of an API request followed by `eventHandlers` to
  # respond to callbacks from the API endpoint.
  actions:
  - name: provision
    request:
      # Requests can add or override parameters sent to the request.
      parameters:
        ACTION: provision
    eventHandlers:
    # The names of events sent by callbacks must be aligned to the API endpoint.
    - event: started
      tasks:
      - name: Set state provisioning in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: provisioning
          status:
            state: provisioning
    - event: complete
      tasks:
      - name: Set state started in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: started
          status:
            state: started
      # Subsequent actions are scheduled to run later with the `after` parameter.
      - name: Schedule stop
        anarchy_schedule_action:
          action: stop
          after: 8h
      - name: Schedule destroy
        anarchy_schedule_action:
          action: destroy
          after: 6d

  - name: stop
    request:
      parameters:
        ACTION: stop
    eventHandlers:
    - event: started
      tasks:
      - name: Set state stopping in subject status
        anarchy_subject_update:
          spec:
            desiredState: stopped
          metadata:
            labels:
              state: stopping
          status:
            state: stopping
    - event: complete
      tasks:
      - name: Set state stopped in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: stopped
          status:
            state: stopped

  - name: start
    request:
      parameters:
        ACTION: start
    eventHandlers:
    - event: started
      tasks:
      - name: Set state starting in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: starting
          status:
            state: starting
    - event: complete
      tasks:
      - name: Set state started in subject status
        anarchy_subject_update:
          metadata:
            labels:
              state: started
          status:
            state: started
      - name: Schedule stop
        anarchy_schedule_action:
          action: stop
          after: 8h

  - name: destroy
    request:
      parameters:
        ACTION: destroy
    eventHandlers:
    - event: complete
      tasks:
      - name: Delete anarchy subject
        # The `anarchy_subject_delete` handler completes AnarchySubject deletion
        # by removing the finalizers from the AnarchySubject metadata.
        anarchy_subject_delete:
          remove_finalizers: true
----

== Testing

=== Examples

Examples are found in the examples folder.
