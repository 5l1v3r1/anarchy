---
apiVersion: gpte.redhat.com/v1
kind: AnarchyGovernor
metadata:
  name: test
spec:
  # List of parameters to pass to the Babylon Tower job template along with
  # whatever parameters are in the AgnosticDeployment. Parameters in the
  # AgnosticDeployment override parameters here.
  #
  # Values may strings or dictionaries that give details on how to fetch the
  # value from a secret.
  parameters:
    cloud_provider: ec2    
    aws_access_key_id:
      secret_name: opentlc_aws_creds
      secret_key: aws_access_key_id
    aws_secret_access_key:
      secret_name: opentlc_aws_creds
      secret_key: aws_secret_access_key
  subjectEventHandlers:
  - event: added
    handlers:
    - handlerType: scheduleAction
      scheduleActionParams:
        action: deploy
  - event: delete
    handlers:
    - handlerType: scheduleAction
      scheduleActionParams:
        action: destroy
  actions:
  - name: deploy
    request:
      api: test
      callbackUrlParameter: callback_url
      method: POST
      path: /api/v2/job_templates/deploy/launch/
    callbackEventNameParameter: event
    eventHandlers:
    - event: started
      handlers:
      - handlerType: email
        emailParams:
          to: ["{{ subject.spec.requester.email }}"]
          from: noreply@opentlc.com
          subject: >-
            {{ governor.metadata.name }} {{ subject.metadata.name }}
            deployment has started
          body: |-
            ... jinja template ...
    - event: complete
      handlers:
      - handlerType: scheduleAction
        scheduleActionParams:
          action: destroy
          after: 6d
      - handlerType: email
        emailParams:
          to: ["{{ subject.spec.requester.email }}"]
          from: noreply@opentlc.com
          subject: >-
            {{ governor.metadata.name }} {{ subject.metadata.name }}
            deployed
          body: |-
            ... jinja template ...
    - event: error
      handlers:
      - handlerType: email
        emailParams:
          to: ["{{ subject.spec.requester.email }}"]
          from: noreply@opentlc.com
          subject: >-
            {{ governor.metadata.name }} {{ subject.metadata.name }}
            deploy error
          body: |-
            ... jinja template ...
  - name: destroy
    request:
      api: test
      callbackUrlParameter: callback_url
      method: POST
      path: /api/v2/job_templates/destroy/launch/
    callbackEventNameParameter: event
    eventHandlers:
    - event: complete
      handlers:
      - handlerType: email
        emailParams:
          to: ["{{ subject.spec.requester.email }}"]
          from: noreply@opentlc.com
          subject: >-
            {{ governor.metadata.name }} {{ subject.metadata.name }}
            destroyed
          body: |-
            ... jinja template â€¦
    - event: error
      handlers:
      - handlerType: email
        emailParams:
          to: ["{{ subject.spec.requester.email }}"]
          from: noreply@opentlc.com
          subject: >-
            {{ governor.metadata.name }} {{ subject.metadata.name }}
            destroy error
          body: |-
            ... jinja template ...
#  - name: suspend
#    api:
#      url: https://...
#    ...
#  - name: resume
#    api:
#      url: https://...
#    eventHandlers:
#    - event: complete
#      handlers:
#      - handlerType: scheduleAction
#        scheduleActionParams:
#          action: suspend
#          after: 8h
#    ...
