---
apiVersion: gpte.redhat.com/v1
kind: AnarchyGovernor
metadata:
  name: {{ anarchy_governor_name }}
  namespace: {{ anarchy_operator_namespace | to_json }}
{% raw %}
spec:
  parameters:
    cloud_provider: ec2
    aws_access_key_id:
      secretName: test-aws-creds
      secretKey: aws_access_key_id
    aws_secret_access_key:
      secretName: test-aws-creds
      secretKey: aws_secret_access_key
  deleteFinalizerCondition:
    check: status.state
    value: destroyed
  subjectEventHandlers:
  - event: add
    handlers:
    - type: scheduleAction
      action: deploy
  - event: delete
    handlers:
    - type: scheduleAction
      action: destroy
  actions:
  - name: deploy
    request:
      api: test
      callbackTokenParameter: anarchy_callback_token
      callbackUrlParameter: anarchy_callback_url
      data: '{{ { "extra_vars": parameters } | to_json }}'
      method: POST
      path: /api/v2/job_templates/deploy/launch/
    callbackEventNameParameter: event
    eventHandlers:
    - event: started
      handlers:
      - type: ansible
        tasks:
        - name: Say Hello
          debug:
            msg: Hello, World
        - name: Check identity
          command: oc whoami
    - event: complete
      handlers:
      - type: setLabels
        setLabels:
        - name: state
          value: deployed
      - type: setStatus
        setStatus:
        - name: state
          value: deployed
      - type: scheduleAction
        action: destroy
        after: 6d
  - name: destroy
    request:
      api: test
      callbackTokenParameter: anarchy_callback_token
      callbackUrlParameter: anarchy_callback_url
      data: '{{ { "extra_vars": parameters } | to_json }}'
      method: POST
      path: /api/v2/job_templates/destroy/launch/
    callbackEventNameParameter: event
    eventHandlers:
    - event: complete
      handlers:
      - type: setLabels
        setLabels:
        - name: state
          value: deployed
      - type: setStatus
        setStatus:
        - name: state
          value: destroyed
{% endraw %}
